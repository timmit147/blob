<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Blob → Shape</title><style>:root{--bg:#0b0f19;--fg:#e9eefc;--muted:rgba(233,238,252,.68);--ui:rgba(255,255,255,.08);--ui-b:rgba(255,255,255,.14)}html,body{height:100%;margin:0}body{background:radial-gradient(1200px 700px at 50% 40%,#151d33 0%,var(--bg) 60%,#070a12 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg);overflow:hidden}.stage{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none}svg{width:min(520px,86vw);height:auto;filter:drop-shadow(0 18px 40px rgba(0,0,0,.55))}.bottom{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);width:min(780px,92vw);pointer-events:auto;z-index:20}.bottom input{width:100%;padding:14px 16px;border-radius:14px;border:1px solid var(--ui-b);background:var(--ui);color:var(--fg);outline:none;font-size:16px;transition:border-color 200ms ease,box-shadow 200ms ease}.bottom input.ok{border-color:rgba(255,255,255,.55)}.bottom input.err{border-color:rgba(255,120,120,.75);box-shadow:0 0 0 3px rgba(255,120,120,.18)}.bottom input.busy{border-color:rgba(255,255,255,.85);animation:pulse 900ms ease-in-out infinite}@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,255,255,.0)}50%{box-shadow:0 0 0 6px rgba(255,255,255,.18)}}#shapeGroup{transition:transform 1800ms cubic-bezier(.2,.9,.2,1);transform-origin:0 0}svg path{transition:fill 600ms ease}.infoBtn{position:fixed;top:14px;right:14px;width:38px;height:38px;border-radius:12px;border:1px solid rgba(0,0,0,.18);background:#d9d9d9;color:#000;display:grid;place-items:center;cursor:pointer;pointer-events:auto;font-weight:800;z-index:50}.infoBtn:hover{background:#e6e6e6}.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;pointer-events:auto;z-index:60}.modal.open{display:flex}.card{width:min(980px,92vw);background:rgba(10,14,25,.95);border:1px solid var(--ui-b);border-radius:16px;padding:16px;box-shadow:0 18px 60px rgba(0,0,0,.6)}.card h3{margin:0 0 10px;font-size:16px}.card p{margin:8px 0;color:var(--muted);font-size:14px;line-height:1.45}.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}.box{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05);border-radius:12px;padding:10px}.box h4{margin:0 0 8px;font-size:14px;color:var(--fg)}.list{margin:0;padding-left:18px;color:var(--muted);font-size:14px;line-height:1.45}code{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:8px;color:var(--fg);font-size:13px}.actions{display:flex;justify-content:flex-end;margin-top:12px}.btn{border:1px solid var(--ui-b);background:var(--ui);color:var(--fg);border-radius:12px;padding:10px 12px;font-size:14px;cursor:pointer}.btn:hover{background:rgba(255,255,255,.12)}#editLayer{display:none}body.editing #editLayer{display:block}.handle{cursor:grab;pointer-events:auto}.handleOutline{fill:rgba(0,0,0,.25)}.handleCore{fill:rgba(255,255,255,.95)}.handleRing{fill:none;stroke:rgba(255,255,255,.35);stroke-width:1.5}.fullscreenDrag{position:fixed;inset:0;display:none;pointer-events:auto;z-index:10}.fullscreenDrag.on{display:block}</style></head><body><button class="infoBtn" id="infoBtn" aria-label="Info">i</button><div class="fullscreenDrag" id="dragOverlay"></div><div class="stage"><svg id="svgRoot" viewBox="-220 -220 440 440" xmlns="http://www.w3.org/2000/svg"><g id="world"><g id="shapeGroup"></g><g id="editLayer"></g></g><g id="measureGroup" visibility="hidden"></g></svg></div><div class="bottom"><input id="cmd" placeholder="Enter: shape name | blob | random | randomize | stoprandom | previous | drag | zoom 10 | zoom -10 | copy | export" autocomplete="off" spellcheck="false"/></div><div class="modal" id="modal" role="dialog" aria-modal="true"><div class="card"><h3>Info</h3><p>Enter runs. Empty + Enter goes to <code>blob</code>.</p><div class="grid"><div class="box"><h4>Commands</h4><ul class="list"><li><code>blob</code></li><li><code>random</code></li><li><code>randomize</code> — every 10s</li><li><code>stoprandom</code></li><li><code>previous</code></li><li><code>drag</code> — full-screen drag</li><li><code>zoom 10</code> / <code>zoom -10</code> / <code>zoom 150</code></li><li><code>edit</code>, <code>edit all</code>, <code>edit next</code>, <code>edit detail 600</code></li><li><code>copy</code>, <code>export</code>, <code>rotate 180</code>, colors</li></ul></div><div class="box"><h4>Shapes list</h4><ul class="list" id="shapeList"></ul></div></div><div class="actions"><button class="btn" id="closeBtn">Close</button></div></div></div><script>(()=>{const TAU=Math.PI*2,lerp=(a,b,t)=>a+(b-a)*t,fmt=n=>Number(n).toFixed(3);const SHAPES=["circle","oval","triangle","square","rectangle","diamond","pentagon","hexagon","star","heart","lightning bolt","plus","cross","check","close","menu","search","home","user","play","pause","stop","download","upload","arrow up","arrow right","chevron","capsule","drop","trapezoid","parallelogram","settings","notification","netherlands"];const POINTS=720,BASE_R=140,TARGET_AREA=Math.PI*BASE_R*BASE_R*1.22;const ROTATE_MS=1800;const MS_TO_BLOB=2800,MS_TO_SHAPE=3600;const MS_ZOOM=750;const BLOB_CTRL=28;const svgRoot=document.getElementById("svgRoot"),world=document.getElementById("world"),group=document.getElementById("shapeGroup"),editLayer=document.getElementById("editLayer"),measureGroup=document.getElementById("measureGroup"),cmd=document.getElementById("cmd"),infoBtn=document.getElementById("infoBtn"),modal=document.getElementById("modal"),closeBtn=document.getElementById("closeBtn"),shapeListEl=document.getElementById("shapeList"),dragOverlay=document.getElementById("dragOverlay");SHAPES.forEach(s=>{const li=document.createElement("li");li.textContent=s;shapeListEl.appendChild(li)});let fillColor="#ffffff",rotationDeg=0;let mode="blob";let renderStyle="smooth";let raf=null;let morphing=false,morphStart=0,morphDur=MS_TO_SHAPE,fromSets=null,toSets=null,morphQueue=[];let currentSets=[makeBlobPoints()];let currentName="blob";let zoomPct=100,panX=0,panY=0;let zoomAnim=null;let dragEnabled=false,dragging=false,dragStartScreen=null,panStart=null;let autoTimer=null;let history=["blob"];function easeInOutCubic(t){return t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2}function easeOutCubic(t){return 1-Math.pow(1-t,3)}function setInputStateBusy(on){cmd.classList.toggle("busy",!!on)}function setInputStateOk(){cmd.classList.remove("err");cmd.classList.add("ok")}function setInputStateErr(){cmd.classList.remove("ok");cmd.classList.add("err");setTimeout(()=>cmd.classList.remove("err"),900)}function updateWorldTransform(){const s=zoomPct/100;world.setAttribute("transform",`translate(${fmt(panX)} ${fmt(panY)}) scale(${fmt(s)})`)}function animateZoomTo(targetPct){targetPct=Math.max(10,Math.min(400,targetPct));const start=performance.now();zoomAnim={start,from:zoomPct,to:targetPct};startRAF()}function setZoom(val){let n=Number(val);if(!Number.isFinite(n))return;let target=Math.abs(n)<50?zoomPct+n:n;animateZoomTo(target)}function makeCirclePoints(r){const pts=[];for(let i=0;i<POINTS;i++){const th=i/POINTS*TAU;pts.push({x:r*Math.cos(th),y:r*Math.sin(th)})}return pts}function makeBlobPoints(){const pts=[];for(let i=0;i<POINTS;i++){const th=i/POINTS*TAU;pts.push({x:BASE_R*Math.cos(th),y:BASE_R*Math.sin(th)})}return pts}function centroid(pts){let cx=0,cy=0;for(const p of pts){cx+=p.x;cy+=p.y}return{x:cx/pts.length,y:cy/pts.length}}function stabilizeCenter(sets){let cx=0,cy=0,count=0;for(const pts of sets)for(const p of pts){cx+=p.x;cy+=p.y;count++}cx/=count;cy/=count;for(const pts of sets)for(const p of pts){p.x-=cx;p.y-=cy}}function polygonArea(pts){let a=0;for(let i=0;i<pts.length;i++){const p=pts[i],q=pts[(i+1)%pts.length];a+=p.x*q.y-q.x*p.y}return a*.5}function totalAreaAbs(sets){let sum=0;for(const pts of sets)sum+=Math.abs(polygonArea(pts));return sum}function maxRadius(sets){let m=0;for(const pts of sets)for(const p of pts)m=Math.max(m,Math.hypot(p.x,p.y));return m}function scaleSets(sets,s){for(const pts of sets)for(const p of pts){p.x*=s;p.y*=s}}function normalizeSizeAndCenterByArea(sets){stabilizeCenter(sets);const a=totalAreaAbs(sets);const sArea=a>1e-6?Math.sqrt(TARGET_AREA/a):1;scaleSets(sets,sArea);const m=maxRadius(sets);if(m>BASE_R)scaleSets(sets,BASE_R/m*.985);stabilizeCenter(sets)}function toSmoothPath(pts){const n=pts.length,p=i=>pts[(i+n)%n];let d="";for(let i=0;i<n;i++){const p0=p(i-1),p1=p(i),p2=p(i+1),p3=p(i+2);const c1x=p1.x+(p2.x-p0.x)/6,c1y=p1.y+(p2.y-p0.y)/6,c2x=p2.x-(p3.x-p1.x)/6,c2y=p2.y-(p3.y-p1.y)/6;if(i===0)d+=`M ${fmt(p1.x)} ${fmt(p1.y)} `;d+=`C ${fmt(c1x)} ${fmt(c1y)}, ${fmt(c2x)} ${fmt(c2y)}, ${fmt(p2.x)} ${fmt(p2.y)} `}return d+"Z"}function ensurePathEls(n){while(group.children.length<n){const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("fill",fillColor);group.appendChild(p)}while(group.children.length>n)group.removeChild(group.lastChild);for(const el of group.children)el.setAttribute("fill",fillColor)}function setFill(c){fillColor=c;for(const el of group.children)el.setAttribute("fill",c)}function setRotation(deg){rotationDeg=deg;group.style.transitionDuration=ROTATE_MS+"ms";group.setAttribute("transform",`rotate(${rotationDeg})`)}function deepCopySets(sets){return sets.map(pts=>pts.map(p=>({x:p.x,y:p.y})))}function alignTargetToCurrent(cur,tgt){const n=cur.length,step=18;function score(shift,rev){let sum=0;for(let i=0;i<n;i+=step){const ti=rev?(((shift-i)%n+n)%n):((i+shift)%n);const dx=cur[i].x-tgt[ti].x,dy=cur[i].y-tgt[ti].y;sum+=dx*dx+dy*dy}return sum}const coarse=28;let bestShift=0,bestRev=false,bestScore=Infinity;for(let sh=0;sh<n;sh+=coarse)for(const rev of[false,true]){const sc=score(sh,rev);if(sc<bestScore){bestScore=sc;bestShift=sh;bestRev=rev}}for(let d=-coarse;d<=coarse;d++){const sh=(bestShift+d+n)%n;for(const rev of[false,true]){const sc=score(sh,rev);if(sc<bestScore){bestScore=sc;bestShift=sh;bestRev=rev}}}const out=new Array(n);for(let i=0;i<n;i++){const ti=bestRev?(((bestShift-i)%n+n)%n):((i+bestShift)%n);out[i]={x:tgt[ti].x,y:tgt[ti].y}}return out}const blobCtrl=Array.from({length:BLOB_CTRL},(_,i)=>({r:1,v:0,seed:(i+1)*999.123}));function rand01(x){const s=Math.sin(x)*43758.5453123;return s-Math.floor(s)}function updateBlobCtrl(dt,t){for(let i=0;i<BLOB_CTRL;i++){const c=blobCtrl[i];const target=1+.085*Math.sin(t*.55+i*.95)+.04*Math.sin(t*.23+i*1.65);const n=(rand01(c.seed+t*.35)-.5)*.16;const k=2.8,damp=2.15;const a=k*(target+n-c.r)-damp*c.v;c.v+=a*dt;c.r+=c.v*dt}}function catmullRomClosed(ctrlPts,samples){const n=ctrlPts.length,out=new Array(samples),get=i=>ctrlPts[(i%n+n)%n];for(let s=0;s<samples;s++){const tt=s/samples*n,i=Math.floor(tt),u=tt-i,p0=get(i-1),p1=get(i),p2=get(i+1),p3=get(i+2),u2=u*u,u3=u2*u;const x=.5*((2*p1.x)+(-p0.x+p2.x)*u+(2*p0.x-5*p1.x+4*p2.x-p3.x)*u2+(-p0.x+3*p1.x-3*p2.x+p3.x)*u3);const y=.5*((2*p1.y)+(-p0.y+p2.y)*u+(2*p0.y-5*p1.y+4*p2.y-p3.y)*u2+(-p0.y+3*p1.y-3*p2.y+p3.y)*u3);out[s]={x,y}}return out}function blobFromCtrl(){const ctrlPts=new Array(BLOB_CTRL);for(let i=0;i<BLOB_CTRL;i++){const th=i/BLOB_CTRL*TAU,r=BASE_R*blobCtrl[i].r;ctrlPts[i]={x:r*Math.cos(th),y:r*Math.sin(th)}}const pts=catmullRomClosed(ctrlPts,POINTS);normalizeSizeAndCenterByArea([pts]);return[pts]}function splitPathData(d){if(!d)return[];const m=d.match(/[Mm][^Mm]*/g);return m?m.map(s=>s.trim()).filter(Boolean):[d]}function elementToPathData(el){const tag=el.tagName.toLowerCase();if(tag==="path")return el.getAttribute("d")||"";if(tag==="polygon"||tag==="polyline"){const pts=(el.getAttribute("points")||"").trim();if(!pts)return"";const nums=pts.split(/[\s,]+/).map(Number).filter(Number.isFinite);if(nums.length<4)return"";let d=`M ${nums[0]} ${nums[1]} `;for(let i=2;i<nums.length;i+=2)d+=`L ${nums[i]} ${nums[i+1]} `;if(tag==="polygon")d+="Z";return d}if(tag==="rect"){const x=Number(el.getAttribute("x")||0),y=Number(el.getAttribute("y")||0),w=Number(el.getAttribute("width")||0),h=Number(el.getAttribute("height")||0),rx=Number(el.getAttribute("rx")||0),ry=Number(el.getAttribute("ry")||0);if(!(w>0&&h>0))return"";if(rx>0||ry>0){const rrx=Math.min(rx||ry,w/2),rry=Math.min(ry||rx,h/2);return[`M ${x+rrx} ${y}`,`L ${x+w-rrx} ${y}`,`A ${rrx} ${rry} 0 0 1 ${x+w} ${y+rry}`,`L ${x+w} ${y+h-rry}`,`A ${rrx} ${rry} 0 0 1 ${x+w-rrx} ${y+h}`,`L ${x+rrx} ${y+h}`,`A ${rrx} ${rry} 0 0 1 ${x} ${y+h-rry}`,`L ${x} ${y+rry}`,`A ${rrx} ${rry} 0 0 1 ${x+rrx} ${y}`,`Z`].join(" ")}return`M ${x} ${y} L ${x+w} ${y} L ${x+w} ${y+h} L ${x} ${y+h} Z`}if(tag==="circle"){const cx=Number(el.getAttribute("cx")||0),cy=Number(el.getAttribute("cy")||0),r=Number(el.getAttribute("r")||0);if(!(r>0))return"";return`M ${cx-r} ${cy} A ${r} ${r} 0 1 0 ${cx+r} ${cy} A ${r} ${r} 0 1 0 ${cx-r} ${cy} Z`}if(tag==="ellipse"){const cx=Number(el.getAttribute("cx")||0),cy=Number(el.getAttribute("cy")||0),rx=Number(el.getAttribute("rx")||0),ry=Number(el.getAttribute("ry")||0);if(!(rx>0&&ry>0))return"";return`M ${cx-rx} ${cy} A ${rx} ${ry} 0 1 0 ${cx+rx} ${cy} A ${rx} ${ry} 0 1 0 ${cx-rx} ${cy} Z`}return""}function parseViewBox(svgEl){const vb=svgEl.getAttribute("viewBox");if(!vb)return null;const parts=vb.trim().split(/[\s,]+/).map(Number);if(parts.length!==4||parts.some(x=>!Number.isFinite(x)))return null;return{minX:parts[0],minY:parts[1]}}function clearMeasureGroup(){while(measureGroup.firstChild)measureGroup.removeChild(measureGroup.firstChild)}function samplePathElement(pathEl){const L=pathEl.getTotalLength();if(!isFinite(L)||L<=0)return null;const pts=[];for(let i=0;i<POINTS;i++){const p=pathEl.getPointAtLength(i/POINTS*L);pts.push({x:p.x,y:p.y})}return pts}const cache={},missing=new Set();async function loadShapeByName(name){const file=name.toLowerCase().trim().replace(/\s+/g,"-")+".svg";if(missing.has(file))return null;if(cache[file])return cache[file];try{const res=await fetch("shapes/"+file,{cache:"force-cache"});if(!res.ok){missing.add(file);return null}const txt=await res.text();const doc=new DOMParser().parseFromString(txt,"image/svg+xml");const svgEl=doc.querySelector("svg");if(!svgEl){missing.add(file);return null}const drawables=[...svgEl.querySelectorAll("path,polygon,polyline,rect,circle,ellipse")];if(!drawables.length){missing.add(file);return null}clearMeasureGroup();const wrap=document.createElementNS("http://www.w3.org/2000/svg","g");measureGroup.appendChild(wrap);const vb=parseViewBox(svgEl);if(vb)wrap.setAttribute("transform",`translate(${-vb.minX} ${-vb.minY})`);const sets=[];for(const el of drawables){const d0=elementToPathData(el);if(!d0)continue;if(el.tagName.toLowerCase()==="path"){const parts=splitPathData(d0);for(const part of parts){const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",part);const tr=el.getAttribute("transform");if(tr)p.setAttribute("transform",tr);wrap.appendChild(p);const pts=samplePathElement(p);if(pts)sets.push(pts)}}else{const p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",d0);const tr=el.getAttribute("transform");if(tr)p.setAttribute("transform",tr);wrap.appendChild(p);const pts=samplePathElement(p);if(pts)sets.push(pts)}}if(!sets.length){missing.add(file);return null}normalizeSizeAndCenterByArea(sets);cache[file]=sets;return sets}catch{missing.add(file);return null}}function combinedBlobFromSets(sets){let cx=0,cy=0,count=0;for(const s of sets)for(const p of s){cx+=p.x;cy+=p.y;count++}cx/=count;cy/=count;const rays=new Array(POINTS).fill(0);for(const s of sets){for(const p of s){const dx=p.x-cx,dy=p.y-cy;const th=Math.atan2(dy,dx);let i=Math.floor(((th+Math.PI)/TAU)*POINTS);i=(i%POINTS+POINTS)%POINTS;const r=Math.hypot(dx,dy);if(r>rays[i])rays[i]=r}}for(let pass=0;pass<14;pass++){const out=rays.slice();for(let i=0;i<POINTS;i++){const a=rays[(i-1+POINTS)%POINTS],b=rays[i],c=rays[(i+1)%POINTS];out[i]=(a+2*b+c)/4}for(let i=0;i<POINTS;i++)rays[i]=out[i]}const pts=[];for(let i=0;i<POINTS;i++){const th=i/POINTS*TAU-Math.PI;const r=rays[i]||BASE_R*.2;pts.push({x:cx+r*Math.cos(th),y:cy+r*Math.sin(th)})}normalizeSizeAndCenterByArea([pts]);return[pts]}function render(){ensurePathEls(currentSets.length);for(let s=0;s<currentSets.length;s++){group.children[s].setAttribute("d",toSmoothPath(currentSets[s]))}}function spawnFromTargets(targetSetsIn){const base=(currentSets[0]||makeCirclePoints(BASE_R)).map(p=>({x:p.x,y:p.y}));const spawned=targetSetsIn.map(tset=>{const b=base.map(p=>({x:p.x,y:p.y}));const ct=centroid(tset),cb=centroid(b);for(const p of b){p.x=(p.x-cb.x)+ct.x;p.y=(p.y-cb.y)+ct.y}return b});normalizeSizeAndCenterByArea(spawned);return spawned}function beginMorph(nextSets,durationMs){if(currentSets.length!==nextSets.length)currentSets=spawnFromTargets(nextSets);const aligned=nextSets.map((pts,idx)=>alignTargetToCurrent(currentSets[idx],pts.map(p=>({x:p.x,y:p.y}))));normalizeSizeAndCenterByArea(currentSets);normalizeSizeAndCenterByArea(aligned);fromSets=deepCopySets(currentSets);toSets=deepCopySets(aligned);morphStart=performance.now();morphDur=durationMs;morphing=true;setInputStateBusy(true);startRAF()}function queueMorph(steps){morphQueue=steps.slice();if(morphQueue.length){const st=morphQueue.shift();beginMorph(st.sets,st.ms)}}function startRAF(){if(raf)cancelAnimationFrame(raf);raf=requestAnimationFrame(tick)}let lastNow=performance.now();function tick(now){const dt=Math.min(.033,(now-lastNow)/1000);lastNow=now;if(zoomAnim){const t=(now-zoomAnim.start)/MS_ZOOM;if(t>=1){zoomPct=zoomAnim.to;zoomAnim=null}else{zoomPct=lerp(zoomAnim.from,zoomAnim.to,easeOutCubic(Math.max(0,Math.min(1,t))))}updateWorldTransform()}if(mode==="blob"&&!morphing&&!isEditing){updateBlobCtrl(dt,now/1000);currentSets=blobFromCtrl();render();raf=requestAnimationFrame(tick);return}if(morphing){const tt=Math.min(1,(now-morphStart)/morphDur),e=easeInOutCubic(tt);const interp=fromSets.map((a,si)=>{const b=toSets[si],out=new Array(POINTS);for(let i=0;i<POINTS;i++)out[i]={x:lerp(a[i].x,b[i].x,e),y:lerp(a[i].y,b[i].y,e)};return out});normalizeSizeAndCenterByArea(interp);currentSets=interp;if(tt>=1){morphing=false;currentSets=deepCopySets(toSets);render();if(morphQueue.length){const st=morphQueue.shift();beginMorph(st.sets,st.ms);return}setInputStateBusy(false);setInputStateOk();if(!isEditing&&!zoomAnim&&mode!=="blob"){raf=null;return}}}render();raf=requestAnimationFrame(tick)}function isCssColor(str){const s=str.trim();if(!s)return false;const test=document.createElement("div");test.style.color="";test.style.color=s;return!!test.style.color}function exportSVGString(){const vb="-220 -220 440 440";const ds=[...group.children].map(p=>p.getAttribute("d")||"").filter(Boolean);const paths=ds.map(d=>`    <path d="${d}" fill="${fillColor}"/>`).join("\n");return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}">\n  <g transform="translate(${panX} ${panY}) scale(${zoomPct/100}) rotate(${rotationDeg})">\n${paths}\n  </g>\n</svg>\n`}function doCopy(){navigator.clipboard.writeText(exportSVGString())}function doExport(){const text=exportSVGString();const blob=new Blob([text],{type:"image/svg+xml;charset=utf-8"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="shape.svg";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}function stopAutoRandom(){if(autoTimer){clearInterval(autoTimer);autoTimer=null}}async function transitionToSets(sets){const steps=[];const blob=combinedBlobFromSets(currentSets);steps.push({sets:blob,ms:MS_TO_BLOB});steps.push({sets:sets,ms:MS_TO_SHAPE});queueMorph(steps)}function pushHistory(name){if(history[history.length-1]!==name)history.push(name)}async function goBlob(){stopAutoRandom();exitEditMode();mode="blob";currentName="blob";pushHistory("blob");setInputStateBusy(false);setInputStateOk();startRAF()}async function applyShape(name){const v=name.trim();if(!v)return;const low=v.toLowerCase();if(low===currentName){setInputStateOk();return}stopAutoRandom();exitEditMode();setInputStateBusy(true);const sets=await loadShapeByName(v);if(!sets){setInputStateBusy(false);setInputStateErr();return}mode="shape";currentName=low;pushHistory(low);await transitionToSets(sets)}function chooseRandomOrder(){const arr=SHAPES.slice();for(let i=arr.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}async function randomExistingShape(){const cur=currentName;const order=chooseRandomOrder();for(const name of order){const low=name.toLowerCase();if(low===cur)continue;const sets=await loadShapeByName(name);if(!sets)continue;stopAutoRandom();exitEditMode();mode="shape";currentName=low;pushHistory(low);await transitionToSets(sets);return true}setInputStateErr();return false}function startAutoRandom(){stopAutoRandom();randomExistingShape();autoTimer=setInterval(()=>{randomExistingShape()},10000)}async function previous(){stopAutoRandom();if(history.length<=1)return;history.pop();const prev=history[history.length-1]||"blob";if(prev==="blob"){await goBlob();return}await applyShape(prev)}function toggleDrag(){dragEnabled=!dragEnabled;dragOverlay.classList.toggle("on",dragEnabled);dragOverlay.style.cursor=dragEnabled?"grab":"default";dragging=false}function onDragDown(e){if(!dragEnabled||isEditing)return;dragging=true;dragStartScreen={x:e.clientX,y:e.clientY};panStart={x:panX,y:panY};dragOverlay.setPointerCapture?.(e.pointerId);dragOverlay.style.cursor="grabbing";e.preventDefault()}function onDragMove(e){if(!dragging)return;const dx=e.clientX-dragStartScreen.x,dy=e.clientY-dragStartScreen.y;const s=zoomPct/100;panX=panStart.x+dx/s;panY=panStart.y+dy/s;updateWorldTransform();startRAF();e.preventDefault()}function onDragUp(){dragging=false;if(dragEnabled)dragOverlay.style.cursor="grab"}dragOverlay.addEventListener("pointerdown",onDragDown);window.addEventListener("pointermove",onDragMove,{passive:false});window.addEventListener("pointerup",onDragUp);infoBtn.addEventListener("click",()=>modal.classList.add("open"));closeBtn.addEventListener("click",()=>modal.classList.remove("open"));modal.addEventListener("click",e=>{if(e.target===modal)modal.classList.remove("open")});window.addEventListener("keydown",e=>{if(e.key==="Escape")modal.classList.remove("open")});cmd.addEventListener("keydown",async e=>{if(e.key!=="Enter")return;const raw=cmd.value.trim();if(!raw){await goBlob();return}const lower=raw.toLowerCase();if(lower==="blob"){await goBlob();return}if(lower==="copy"){doCopy();setInputStateOk();return}if(lower==="export"){doExport();setInputStateOk();return}if(lower==="random"){await randomExistingShape();return}if(lower==="randomize"){startAutoRandom();setInputStateOk();return}if(lower==="stoprandom"){stopAutoRandom();setInputStateOk();return}if(lower==="previous"){await previous();return}if(lower==="drag"){toggleDrag();setInputStateOk();return}if(lower.startsWith("zoom ")){setZoom(lower.slice(5).trim());setInputStateOk();return}if(lower.startsWith("rotate ")){const n=parseFloat(raw.slice(7).trim());if(Number.isFinite(n))setRotation(rotationDeg+n);setInputStateOk();return}if(isCssColor(raw)){setFill(raw);setInputStateOk();return}if(lower==="edit"){toggleEditMode();setInputStateOk();return}if(lower==="edit all"){setEditAll(true);setInputStateOk();return}if(lower==="edit next"){editNextSet();setInputStateOk();return}if(lower.startsWith("edit detail ")){const n=parseInt(lower.slice(12).trim(),10);if(Number.isFinite(n)&&n>=60&&n<=3000){setEditDetail(n);setInputStateOk();return}}await applyShape(raw)});let isEditing=false,editAll=false,activeSet=0,editDetail=520,handles=[],dragH=-1,dragHStart=null,origPt=null;function svgPointFromClient(clientX,clientY){const pt=svgRoot.createSVGPoint();pt.x=clientX;pt.y=clientY;const ctm=svgRoot.getScreenCTM();if(!ctm)return{x:0,y:0};const inv=ctm.inverse();const p=pt.matrixTransform(inv);return{x:p.x,y:p.y}}function clearEditLayer(){while(editLayer.firstChild)editLayer.removeChild(editLayer.firstChild)}function buildHandleNode(i){const g=document.createElementNS("http://www.w3.org/2000/svg","g");g.setAttribute("class","handle");g.dataset.i=String(i);const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("r","6.6");o.setAttribute("class","handleOutline");g.appendChild(o);const c=document.createElementNS("http://www.w3.org/2000/svg","circle");c.setAttribute("r","4.6");c.setAttribute("class","handleCore");g.appendChild(c);const r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("r","8.4");r.setAttribute("class","handleRing");g.appendChild(r);return g}function rebuildHandles(){clearEditLayer();handles=[];const setsToEdit=editAll?currentSets.map((_,i)=>i):[Math.min(activeSet,currentSets.length-1)];for(const si of setsToEdit){const pts=currentSets[si];const count=Math.min(editDetail,pts.length);for(let k=0;k<count;k++){const idx=Math.floor(k/count*pts.length);handles.push({si,idx,node:null})}}for(let i=0;i<handles.length;i++){const node=buildHandleNode(i);handles[i].node=node;editLayer.appendChild(node)}updateEditHandles()}function updateEditHandles(){if(!isEditing)return;for(let i=0;i<handles.length;i++){const h=handles[i];const p=currentSets[h.si][h.idx];h.node.setAttribute("transform",`translate(${fmt(p.x)} ${fmt(p.y)})`)}}function applyBrushMove(si,centerIdx,dx,dy){const pts=currentSets[si],n=pts.length;const spread=Math.max(18,Math.floor((POINTS/editDetail)*26));for(let o=-spread;o<=spread;o++){const j=(centerIdx+o+n)%n;const w=Math.exp(-(o*o)/(spread*spread*0.30));pts[j].x+=dx*w;pts[j].y+=dy*w}}function onHandleDown(e){const t=e.target.closest?.(".handle");if(!t)return;dragH=Number(t.dataset.i);dragHStart=svgPointFromClient(e.clientX,e.clientY);const h=handles[dragH];origPt={x:currentSets[h.si][h.idx].x,y:currentSets[h.si][h.idx].y};t.setPointerCapture?.(e.pointerId);e.preventDefault()}function onHandleMove(e){if(!isEditing||dragH<0)return;const p=svgPointFromClient(e.clientX,e.clientY);const dx=p.x-dragHStart.x,dy=p.y-dragHStart.y;const h=handles[dragH];const cur=currentSets[h.si][h.idx];const ddx=(origPt.x+dx)-cur.x,ddy=(origPt.y+dy)-cur.y;applyBrushMove(h.si,h.idx,ddx,ddy);normalizeSizeAndCenterByArea(currentSets);render();startRAF();e.preventDefault()}function onHandleUp(){dragH=-1;dragHStart=null;origPt=null}function enterEditMode(){stopAutoRandom();if(isEditing)return;isEditing=true;document.body.classList.add("editing");if(mode==="blob"){mode="shape";currentName="custom";currentSets=combinedBlobFromSets(currentSets);pushHistory("custom")}rebuildHandles();svgRoot.addEventListener("pointerdown",onHandleDown);window.addEventListener("pointermove",onHandleMove,{passive:false});window.addEventListener("pointerup",onHandleUp);startRAF()}function exitEditMode(){if(!isEditing)return;isEditing=false;document.body.classList.remove("editing");svgRoot.removeEventListener("pointerdown",onHandleDown);window.removeEventListener("pointermove",onHandleMove);window.removeEventListener("pointerup",onHandleUp);clearEditLayer();if(!morphing&&!zoomAnim&&mode!=="blob"){if(raf)cancelAnimationFrame(raf);raf=null}}function toggleEditMode(){isEditing?exitEditMode():enterEditMode()}function setEditAll(v){editAll=!!v;if(isEditing)rebuildHandles()}function editNextSet(){activeSet=(activeSet+1)%Math.max(1,currentSets.length);editAll=false;if(isEditing)rebuildHandles()}function setEditDetail(n){editDetail=n;if(isEditing)rebuildHandles()}function init(){setFill("#ffffff");setRotation(0);updateWorldTransform();cmd.classList.add("ok");goBlob()}init()})();</script></body></html>
